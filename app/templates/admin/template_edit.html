{% extends "base.html" %}

{% block title %}{{ 'Edit' if template else 'New' }} Template - Receipt Printer{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h1 class="card-title">{{ 'Edit Template' if template else 'New Template' }}</h1>
        <a href="{{ url_for('admin.templates_list') }}" class="btn btn-secondary">Back to List</a>
    </div>

    <form method="POST" id="template-form">
        <div class="form-group">
            <label for="name">Template Name</label>
            <input type="text" id="name" name="name" class="form-control"
                   value="{{ template.name if template else name|default('', true) }}" required>
        </div>

        <div class="form-group">
            <label for="description">Description</label>
            <input type="text" id="description" name="description" class="form-control"
                   value="{{ template.description if template else description|default('', true) }}"
                   placeholder="Optional description">
        </div>

        <div class="editor-container">
            <div>
                <div class="form-group">
                    <label for="content">Template Content</label>
                    <textarea id="content" name="content" class="form-control" rows="20">{{ template.content if template else content|default('', true) }}</textarea>
                </div>
                <div class="flex gap-1 mt-1">
                    <button type="submit" class="btn btn-primary">Save Template</button>
                    <button type="button" id="preview-btn" class="btn btn-secondary">Update Preview</button>
                    {% if template %}
                    <a href="{{ url_for('print.print_template', template_id=template.id) }}" class="btn btn-success">Print</a>
                    {% endif %}
                </div>

                <div class="card mt-2">
                    <h4>DSL Reference</h4>
                    <small>
                        <strong>Formatting:</strong> [bold], [underline], [double-height], [double-width]<br>
                        <strong>Alignment:</strong> [center], [right], [left]<br>
                        <strong>Layout:</strong> [line], [feed n="3"], [cut]<br>
                        <strong>Graphics:</strong> [barcode type="code128"]data[/barcode], [qr]data[/qr]<br>
                        <strong>Variables:</strong> {% raw %}{{variable_name}}{% endraw %}<br>
                        <strong>Loops:</strong> {% raw %}{{#each items}}...{{name}}...{{/each}}{% endraw %}
                    </small>
                </div>
            </div>

            <div>
                <label>Preview</label>
                <div id="preview" class="receipt-preview">
                    Loading preview...
                </div>
                <div class="mt-1">
                    <small>Variables found: <span id="variables-list">-</span></small>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    const previewEl = document.getElementById('preview');
    const contentEl = document.getElementById('content');
    const variablesEl = document.getElementById('variables-list');
    const previewBtn = document.getElementById('preview-btn');

    function updatePreview() {
        const content = contentEl.value;

        fetch('{{ url_for("admin.template_preview_content") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ content: content })
        })
        .then(response => response.json())
        .then(data => {
            previewEl.textContent = data.preview;
            variablesEl.textContent = data.variables.join(', ') || 'none';
        })
        .catch(error => {
            previewEl.textContent = 'Error generating preview';
        });
    }

    // Initial preview
    updatePreview();

    // Update on button click
    previewBtn.addEventListener('click', updatePreview);

    // Debounced auto-update on typing
    let debounceTimer;
    contentEl.addEventListener('input', () => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(updatePreview, 500);
    });
</script>
{% endblock %}
